<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Pharmacy System - MedTechAI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; }
        .header h1 { text-align: center; font-size: 2.5em; }
        .nav-tabs { display: flex; justify-content: center; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-tab { padding: 15px 30px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-tab.active { border-bottom-color: #667eea; background: #f8f9ff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd8; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; }
        .status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-filled { background: #d4edda; color: #155724; }
        .status-ready { background: #cce5ff; color: #004085; }
        .pos-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .total { font-size: 1.5em; font-weight: bold; color: #28a745; text-align: center; margin: 20px 0; }
        .cerner-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .online { background: #28a745; }
        .offline { background: #dc3545; }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .nav-tabs { flex-wrap: wrap; }
            .nav-tab { flex: 1; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Smart Pharmacy System</h1>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('cerner')">Cerner Integration</div>
        <div class="nav-tab" onclick="showTab('prescriptions')">Prescriptions</div>
        <div class="nav-tab" onclick="showTab('inventory')">Inventory</div>
        <div class="nav-tab" onclick="showTab('pos')">Point of Sale</div>
        <div class="nav-tab" onclick="showTab('reports')">Reports</div>
    </div>

    <div class="container">
        <!-- Cerner Integration Tab -->
        <div id="cerner" class="tab-content active">
            <div class="grid grid-2">
                <div class="card">
                    <h2>Cerner PowerChart Integration</h2>
                    <p><span class="cerner-status online"></span>Connected to Cerner</p>
                    <div class="form-group">
                        <label>Patient MRN</label>
                        <input type="text" id="patientMRN" placeholder="Enter Medical Record Number">
                    </div>
                    <button onclick="fetchPatientData()" class="btn btn-primary">Fetch Patient Data</button>
                    <div id="patientData" style="margin-top: 20px;"></div>
                </div>
                <div class="card">
                    <h2>Active Orders Queue</h2>
                    <div id="cernerOrders"></div>
                </div>
            </div>
        </div>

        <!-- Prescriptions Tab -->
        <div id="prescriptions" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <h2>New Prescription</h2>
                    <form id="prescriptionForm">
                        <div class="form-group">
                            <label>Patient Name</label>
                            <input type="text" id="patientName" required>
                        </div>
                        <div class="form-group">
                            <label>Medication</label>
                            <input type="text" id="medication" required>
                        </div>
                        <div class="form-group">
                            <label>Dosage</label>
                            <input type="text" id="dosage" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="quantity" required>
                        </div>
                        <div class="form-group">
                            <label>Doctor</label>
                            <input type="text" id="doctor" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Prescription</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Prescription Queue</h2>
                    <div id="prescriptionQueue"></div>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="grid grid-3">
                <div class="card">
                    <h2>Add Medication</h2>
                    <form id="inventoryForm">
                        <div class="form-group">
                            <label>Medication Name</label>
                            <input type="text" id="medName" required>
                        </div>
                        <div class="form-group">
                            <label>NDC Number</label>
                            <input type="text" id="ndcNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="medQuantity" required>
                        </div>
                        <div class="form-group">
                            <label>Price</label>
                            <input type="number" step="0.01" id="medPrice" required>
                        </div>
                        <button type="submit" class="btn btn-success">Add to Inventory</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Current Inventory</h2>
                    <div id="inventoryList"></div>
                </div>
                <div class="card">
                    <h2>Low Stock Alerts</h2>
                    <div id="lowStockAlerts"></div>
                </div>
            </div>
        </div>

        <!-- POS Tab -->
        <div id="pos" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <h2>Point of Sale</h2>
                    <div class="form-group">
                        <label>Search Medication</label>
                        <input type="text" id="posSearch" placeholder="Search by name or NDC" oninput="searchMedication()">
                    </div>
                    <div id="searchResults"></div>
                </div>
                <div class="card">
                    <h2>Current Sale</h2>
                    <div id="currentSale"></div>
                    <div class="total" id="saleTotal">Total: $0.00</div>
                    <button onclick="processSale()" class="btn btn-success" style="width: 100%;">Process Payment</button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <h2>Daily Sales Report</h2>
                    <div id="dailySales"></div>
                </div>
                <div class="card">
                    <h2>Prescription Analytics</h2>
                    <div id="prescriptionAnalytics"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 
            'http://localhost:3000/api' : 'http://100.21.85.166:3000/api';
        let currentSaleItems = [];
        let inventory = [];
        let prescriptions = [];

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Cerner Integration
        async function fetchPatientData() {
            const mrn = document.getElementById('patientMRN').value;
            if (!mrn) return;

            const patientData = {
                mrn: mrn,
                name: 'John Doe',
                dob: '1985-03-15',
                allergies: ['Penicillin', 'Sulfa'],
                activeOrders: [
                    { medication: 'Lisinopril 10mg', status: 'Pending', orderTime: '2024-01-15 10:30' },
                    { medication: 'Metformin 500mg', status: 'Ready', orderTime: '2024-01-15 09:15' }
                ]
            };

            document.getElementById('patientData').innerHTML = `
                <div class="item">
                    <strong>${patientData.name}</strong><br>
                    <small>MRN: ${patientData.mrn} | DOB: ${patientData.dob}</small><br>
                    <strong>Allergies:</strong> ${patientData.allergies.join(', ')}
                </div>
            `;

            loadCernerOrders(patientData.activeOrders);
        }

        function loadCernerOrders(orders) {
            document.getElementById('cernerOrders').innerHTML = orders.map(order => `
                <div class="item">
                    <strong>${order.medication}</strong>
                    <span class="status status-${order.status.toLowerCase()}">${order.status}</span><br>
                    <small>Ordered: ${order.orderTime}</small>
                    <button onclick="processOrder('${order.medication}')" class="btn btn-primary" style="margin-top: 10px;">Process</button>
                </div>
            `).join('');
        }

        // Prescription Management
        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prescription = {
                id: Date.now(),
                patientName: document.getElementById('patientName').value,
                medication: document.getElementById('medication').value,
                dosage: document.getElementById('dosage').value,
                quantity: document.getElementById('quantity').value,
                doctor: document.getElementById('doctor').value,
                status: 'pending',
                timestamp: new Date().toLocaleString()
            };

            prescriptions.push(prescription);
            document.getElementById('prescriptionForm').reset();
            loadPrescriptionQueue();
        });

        function loadPrescriptionQueue() {
            document.getElementById('prescriptionQueue').innerHTML = prescriptions.map(p => `
                <div class="item">
                    <strong>${p.patientName}</strong> - ${p.medication} ${p.dosage}<br>
                    <small>Qty: ${p.quantity} | Dr. ${p.doctor} | ${p.timestamp}</small>
                    <span class="status status-${p.status}">${p.status}</span><br>
                    <button onclick="fillPrescription(${p.id})" class="btn btn-success" style="margin-top: 10px;">Fill</button>
                </div>
            `).join('');
        }

        function fillPrescription(id) {
            const prescription = prescriptions.find(p => p.id === id);
            if (prescription) {
                prescription.status = 'filled';
                loadPrescriptionQueue();
            }
        }

        // Inventory Management
        document.getElementById('inventoryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const medication = {
                id: Date.now(),
                name: document.getElementById('medName').value,
                ndc: document.getElementById('ndcNumber').value,
                quantity: parseInt(document.getElementById('medQuantity').value),
                price: parseFloat(document.getElementById('medPrice').value)
            };

            inventory.push(medication);
            document.getElementById('inventoryForm').reset();
            loadInventory();
            checkLowStock();
        });

        function loadInventory() {
            document.getElementById('inventoryList').innerHTML = inventory.map(med => `
                <div class="item">
                    <strong>${med.name}</strong><br>
                    <small>NDC: ${med.ndc} | Qty: ${med.quantity} | $${med.price}</small>
                </div>
            `).join('');
        }

        function checkLowStock() {
            const lowStock = inventory.filter(med => med.quantity < 10);
            document.getElementById('lowStockAlerts').innerHTML = lowStock.length ? 
                lowStock.map(med => `
                    <div class="item" style="border-left-color: #dc3545;">
                        <strong>${med.name}</strong><br>
                        <small>Only ${med.quantity} remaining</small>
                    </div>
                `).join('') : '<p>No low stock alerts</p>';
        }

        // POS System
        function searchMedication() {
            const query = document.getElementById('posSearch').value.toLowerCase();
            const results = inventory.filter(med => 
                med.name.toLowerCase().includes(query) || med.ndc.includes(query)
            );

            document.getElementById('searchResults').innerHTML = results.map(med => `
                <div class="pos-item">
                    <div>
                        <strong>${med.name}</strong><br>
                        <small>$${med.price} | Stock: ${med.quantity}</small>
                    </div>
                    <button onclick="addToSale(${med.id})" class="btn btn-primary">Add</button>
                </div>
            `).join('');
        }

        function addToSale(medId) {
            const medication = inventory.find(med => med.id === medId);
            if (medication && medication.quantity > 0) {
                currentSaleItems.push(medication);
                medication.quantity--;
                updateCurrentSale();
                loadInventory();
            }
        }

        function updateCurrentSale() {
            const total = currentSaleItems.reduce((sum, item) => sum + item.price, 0);
            
            document.getElementById('currentSale').innerHTML = currentSaleItems.map((item, index) => `
                <div class="pos-item">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>$${item.price}</small>
                    </div>
                    <button onclick="removeFromSale(${index})" class="btn btn-danger">Remove</button>
                </div>
            `).join('');

            document.getElementById('saleTotal').textContent = `Total: $${total.toFixed(2)}`;
        }

        function removeFromSale(index) {
            const item = currentSaleItems[index];
            const medication = inventory.find(med => med.id === item.id);
            if (medication) medication.quantity++;
            
            currentSaleItems.splice(index, 1);
            updateCurrentSale();
            loadInventory();
        }

        function processSale() {
            if (currentSaleItems.length === 0) return;
            
            alert('Payment processed successfully!');
            currentSaleItems = [];
            updateCurrentSale();
            loadReports();
        }

        // Reports
        function loadReports() {
            document.getElementById('dailySales').innerHTML = `
                <div class="item">
                    <strong>Today's Sales: $247.50</strong><br>
                    <small>15 transactions completed</small>
                </div>
            `;

            document.getElementById('prescriptionAnalytics').innerHTML = `
                <div class="item">
                    <strong>Prescriptions Filled: 23</strong><br>
                    <small>Average processing time: 12 minutes</small>
                </div>
            `;
        }

        // Backend API Integration
        async function loadPrescriptionQueue() {
            try {
                const response = await fetch(`${API_BASE}/pharmacy/prescriptions`);
                const data = await response.json();
                prescriptions = data;
                
                document.getElementById('prescriptionQueue').innerHTML = prescriptions.map(p => `
                    <div class="item">
                        <strong>${p.patient_name}</strong> - ${p.medication_name} ${p.dosage}<br>
                        <small>Qty: ${p.quantity} | Dr. ${p.doctor_name} | ${new Date(p.created_at).toLocaleString()}</small>
                        <span class="status status-${p.status}">${p.status}</span><br>
                        <button onclick="fillPrescription(${p.id})" class="btn btn-success" style="margin-top: 10px;">Fill</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading prescriptions:', error);
            }
        }

        async function loadInventory() {
            try {
                const response = await fetch(`${API_BASE}/pharmacy/inventory`);
                const data = await response.json();
                inventory = data;
                
                document.getElementById('inventoryList').innerHTML = inventory.map(med => `
                    <div class="item">
                        <strong>${med.medication_name}</strong><br>
                        <small>NDC: ${med.ndc_number} | Qty: ${med.quantity_on_hand} | $${med.unit_price}</small>
                        ${med.isLowStock ? '<span style="color: red;">⚠️ Low Stock</span>' : ''}
                    </div>
                `).join('');
                
                checkLowStock();
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        async function fillPrescription(id) {
            try {
                const response = await fetch(`${API_BASE}/pharmacy/dispense`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prescriptionId: id, 
                        pharmacistId: 1, 
                        quantityDispensed: 30 
                    })
                });
                
                if (response.ok) {
                    loadPrescriptionQueue();
                    loadInventory();
                }
            } catch (error) {
                console.error('Error filling prescription:', error);
            }
        }

        // Enhanced prescription form with API
        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const prescriptionData = {
                patient_name: document.getElementById('patientName').value,
                medication_name: document.getElementById('medication').value,
                dosage: document.getElementById('dosage').value,
                quantity: parseInt(document.getElementById('quantity').value),
                doctor_name: document.getElementById('doctor').value,
                status: 'pending'
            };

            try {
                const response = await fetch(`${API_BASE}/pharmacy/prescriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prescriptionData)
                });
                
                if (response.ok) {
                    document.getElementById('prescriptionForm').reset();
                    loadPrescriptionQueue();
                }
            } catch (error) {
                console.error('Error adding prescription:', error);
            }
        });

        // Enhanced inventory form with API
        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const medicationData = {
                medication_name: document.getElementById('medName').value,
                ndc_number: document.getElementById('ndcNumber').value,
                quantity_on_hand: parseInt(document.getElementById('medQuantity').value),
                unit_price: parseFloat(document.getElementById('medPrice').value),
                minimum_stock_level: 10
            };

            try {
                const response = await fetch(`${API_BASE}/pharmacy/inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(medicationData)
                });
                
                if (response.ok) {
                    document.getElementById('inventoryForm').reset();
                    loadInventory();
                }
            } catch (error) {
                console.error('Error adding medication:', error);
            }
        });

        // Enhanced POS with real inventory
        function searchMedication() {
            const query = document.getElementById('posSearch').value.toLowerCase();
            const results = inventory.filter(med => 
                med.medication_name.toLowerCase().includes(query) || 
                med.ndc_number.includes(query)
            );

            document.getElementById('searchResults').innerHTML = results.map(med => `
                <div class="pos-item">
                    <div>
                        <strong>${med.medication_name}</strong><br>
                        <small>$${med.unit_price} | Stock: ${med.quantity_on_hand}</small>
                    </div>
                    <button onclick="addToSale(${med.id})" class="btn btn-primary">Add</button>
                </div>
            `).join('');
        }

        function addToSale(medId) {
            const medication = inventory.find(med => med.id === medId);
            if (medication && medication.quantity_on_hand > 0) {
                currentSaleItems.push(medication);
                updateCurrentSale();
            }
        }

        async function processSale() {
            if (currentSaleItems.length === 0) return;
            
            try {
                // Update inventory for each sold item
                for (const item of currentSaleItems) {
                    await fetch(`${API_BASE}/pharmacy/inventory/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            medicationId: item.id,
                            quantityChange: -1,
                            notes: 'POS Sale'
                        })
                    });
                }
                
                alert('Payment processed successfully!');
                currentSaleItems = [];
                updateCurrentSale();
                loadInventory();
                loadReports();
            } catch (error) {
                console.error('Error processing sale:', error);
            }
        }

        // Initialize with API data
        loadPrescriptionQueue();
        loadInventory();
        loadReports();
        loadCernerOrders([
            { medication: 'Lisinopril 10mg', status: 'Pending', orderTime: '2024-01-15 10:30' },
            { medication: 'Metformin 500mg', status: 'Ready', orderTime: '2024-01-15 09:15' }
        ]);
    </script>
</body>
</html>